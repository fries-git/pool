<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Pool (8-ball) — Multiplayer</title>
<style>
  :root{--bg:#121212;--panel:#1e1e1e;--accent:#2a9df4;--muted:#aaa}
  html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui}
  .top{display:flex;gap:8px;padding:12px;align-items:center}
  input,button{padding:8px;border-radius:8px;border:none;background:var(--panel);color:#eee}
  button{background:var(--accent);cursor:pointer}
  #container{display:flex;gap:12px;align-items:flex-start;justify-content:center;padding-bottom:24px}
  canvas{border:8px solid #111;box-shadow:0 8px 40px rgba(0,0,0,0.7);background:#01361f}
  .panel{width:220px;background:var(--panel);padding:10px;border-radius:8px;max-height:520px;overflow:auto}
  .players .current{color:var(--accent);font-weight:700}
  .pocketed{display:flex;gap:6px;flex-wrap:wrap}
  .ball-swatch{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:#000;border:2px solid #222}
  .stripe{border-radius:50%;position:relative;overflow:hidden}
  .stripe::after{content:'';position:absolute;left:0;right:0;top:42%;height:16%;background:#fff;opacity:0.92}
  .notice{color:var(--muted);font-size:13px;margin-top:6px}
</style>
</head>
<body>
<div class="top">
  <input id="username" placeholder="username" />
  <button id="create">Create</button>
  <input id="room" placeholder="ROOM" style="text-transform:uppercase" />
  <button id="join">Join</button>
  <div id="status" style="margin-left:12px;color:#ccc">disconnected</div>
</div>

<div id="container">
  <canvas id="table" width="800" height="400"></canvas>

  <div class="panel">
    <div><strong>Players</strong></div>
    <div id="players" class="players"></div>
    <hr />
    <div><strong>Pocketed</strong></div>
    <div id="pocketed" class="pocketed"></div>
    <hr />
    <div><strong>Chat</strong></div>
    <div id="chatbox" style="height:180px;overflow:auto;margin-bottom:6px"></div>
    <input id="chat" placeholder="message" />
    <div class="notice" id="notice">Not in a room</div>
  </div>
</div>

<script>
const canvas = document.getElementById('table');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const playersEl = document.getElementById('players');
const pocketedEl = document.getElementById('pocketed');
const chatBox = document.getElementById('chatbox');
const noticeEl = document.getElementById('notice');

let ws = null;
let myId = null;
let roomState = null;
let roomCode = null;
let username = '';

function status(s){ statusEl.textContent = s; }
function connectToServer(){
  if(ws && (ws.readyState === 1||ws.readyState===0)) return;
  ws = new WebSocket(window.location.origin.replace(/^http/, 'ws'));
  ws.onopen = ()=> status('connected');
  ws.onclose = ()=> status('disconnected');
  ws.onmessage = ev => {
    const m = JSON.parse(ev.data);
    if(m.t === 'joined'){ roomCode = m.code; myId = m.id; status('in room ' + roomCode); noticeEl.textContent = 'In room ' + roomCode; }
    else if(m.t === 'state'){ roomState = m.state; renderUI(); }
    else if(m.t === 'chat'){ addChat(m.from + ': ' + m.msg); }
    else if(m.t === 'assigned'){ addChat('SYSTEM: ' + m.playerId + ' assigned ' + m.group); }
    else if(m.t === 'game_over'){ addChat('GAME OVER: ' + (m.winner || 'Unknown') + ' — ' + m.reason); noticeEl.textContent = 'Game over: ' + (m.reason || ''); }
    else if(m.t === 'error'){ addChat('ERROR: ' + (m.msg || '')); }
  };
}

document.getElementById('create').onclick = ()=>{
  username = (document.getElementById('username').value || 'Player').trim();
  connectToServer();
  if(ws.readyState === 1) ws.send(JSON.stringify({ t:'create', name: username }));
  else ws.addEventListener('open', ()=> ws.send(JSON.stringify({ t:'create', name: username })), { once: true });
};
document.getElementById('join').onclick = ()=>{
  username = (document.getElementById('username').value || 'Player').trim();
  const code = (document.getElementById('room').value || '').trim().toUpperCase();
  if(!code) return;
  connectToServer();
  if(ws.readyState === 1) ws.send(JSON.stringify({ t:'join', code, name: username }));
  else ws.addEventListener('open', ()=> ws.send(JSON.stringify({ t:'join', code, name: username })), { once: true });
};

document.getElementById('chat').addEventListener('keydown', e=>{
  if(e.key === 'Enter' && ws && ws.readyState === 1){
    const txt = e.target.value.trim();
    if(!txt) return;
    ws.send(JSON.stringify({ t:'chat', msg: txt }));
    e.target.value = '';
  }
});

function addChat(s){
  const d = document.createElement('div');
  d.textContent = s;
  chatBox.appendChild(d);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* drawing helpers */
function drawTable(){
  // green felt background (canvas already set)
  ctx.fillStyle = '#01361f';
  ctx.fillRect(0,0,800,400);
  // draw pockets
  ctx.fillStyle = '#000';
  const pockets = [{x:0,y:0},{x:400,y:0},{x:800,y:0},{x:0,y:400},{x:400,y:400},{x:800,y:400}];
  pockets.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 24, 0, Math.PI*2);
    ctx.fill();
  });
}

function drawBall(b){
  const x = b.x, y = b.y, r = b.r || 10;
  if(b.stripe){
    // white ring
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    // colored inner circle smaller so it looks like stripe
    ctx.beginPath();
    ctx.arc(x,y,r*0.66,0,Math.PI*2);
    ctx.fillStyle = b.color || '#ccc';
    ctx.fill();
  } else {
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle = b.color || '#ccc';
    ctx.fill();
  }
  // outline
  ctx.lineWidth = 1;
  ctx.strokeStyle = '#222';
  ctx.stroke();

  // number
  if(b.num !== 0){
    ctx.fillStyle = '#000';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(String(b.num), x, y);
  }
}

/* aim preview and input */
let dragging = null;
canvas.addEventListener('mousedown', e=>{
  if(!roomState) return;
  if(!roomState.turn || roomState.turn !== myId) return;
  if(!roomState.ballInHand && !allBallsStopped()) return;
  // if ballInHand is true then clicking places cue ball
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  if(roomState.ballInHand){
    // send place_cue (server expects place_cue with x,y)
    if(ws && ws.readyState === 1){
      ws.send(JSON.stringify({ t:'place_cue', x: mx, y: my }));
    }
    return;
  }
  // start aiming
  const cue = roomState.balls.find(b => b.id === 'cue');
  if(!cue) return;
  dragging = { cx: cue.x, cy: cue.y, mx, my };
});
canvas.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const rect = canvas.getBoundingClientRect();
  dragging.mx = e.clientX - rect.left;
  dragging.my = e.clientY - rect.top;
});
window.addEventListener('mouseup', e=>{
  if(!dragging) return;
  // send shoot
  const dx = dragging.cx - dragging.mx;
  const dy = dragging.cy - dragging.my;
  const dist = Math.hypot(dx, dy);
  const power = Math.min(1, dist / 180);
  const angle = Math.atan2(dy, dx) + Math.PI;
  if(ws && ws.readyState === 1){
    ws.send(JSON.stringify({ t:'shoot', power, angle }));
  }
  dragging = null;
});

/* utilities */
function allBallsStopped(){
  if(!roomState) return true;
  return roomState.balls.every(b => Math.hypot(b.vx || 0, b.vy || 0) < 0.06);
}

/* rendering loop */
function render(){
  drawTable();
  if(roomState){
    // balls
    roomState.balls.forEach(b => drawBall(b));
    // pocketed display
    pocketedEl.innerHTML = '';
    if(roomState.pocketed && roomState.pocketed.length){
      roomState.pocketed.forEach(n => {
        if(n === 0) return; // cue not shown here
        const span = document.createElement('div');
        span.className = 'ball-swatch' + (n >= 9 ? ' stripe' : '');
        span.style.background = '#fff';
        // inner colored circle for solids and stripes: create child circle
        const inner = document.createElement('div');
        inner.style.width = '18px';
        inner.style.height = '18px';
        inner.style.borderRadius = '50%';
        inner.style.margin = '0 auto';
        inner.style.marginTop = '4px';
        // color mapping simple:
        const map = {1:'#FFD400',2:'#0047AB',3:'#C41E3A',4:'#6A0DAD',5:'#FF8C00',6:'#006400',7:'#6F1D1B',
                      9:'#FFD400',10:'#0047AB',11:'#C41E3A',12:'#6A0DAD',13:'#FF8C00',14:'#006400',15:'#6F1D1B'};
        inner.style.background = map[n] || '#ddd';
        span.appendChild(inner);
        pocketedEl.appendChild(span);
      });
    }

    // players
    playersEl.innerHTML = '';
    roomState.players.forEach(p => {
      const div = document.createElement('div');
      div.textContent = (p.name || p.id) + (p.group ? ' (' + p.group + ')' : '');
      if(roomState.turn === p.id) div.className = 'current';
      playersEl.appendChild(div);
    });

    // notices
    if(roomState.ballInHand){
      noticeEl.textContent = 'Ball-in-hand: place the cue ball (click table)';
    } else if(!allBallsStopped()){
      noticeEl.textContent = 'Balls moving...';
    } else if(roomState.turn === myId){
      noticeEl.textContent = 'Your turn. Click-drag to shoot.';
    } else {
      const p = roomState.players.find(pp => pp.id === roomState.turn);
      noticeEl.textContent = p ? `Waiting for ${p.name}` : 'Waiting...';
    }

    // draw aiming line preview
    if(dragging){
      const cx = dragging.cx, cy = dragging.cy, mx = dragging.mx, my = dragging.my;
      const dx = mx - cx, dy = my - cy;
      const angle = Math.atan2(dy, dx);
      const len = 80;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(angle) * len, cy + Math.sin(angle) * len);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // show last event
    if(roomState.lastEvent){
      // display briefly in chat
      addChat('EVENT: ' + JSON.stringify(roomState.lastEvent));
    }
  } else {
    playersEl.innerHTML = '';
    pocketedEl.innerHTML = '';
    noticeEl.textContent = 'Not in a room';
  }

  requestAnimationFrame(render);
}

/* request state periodically */
setInterval(()=>{ if(ws && ws.readyState === 1) ws.send(JSON.stringify({ t:'request_state' })); }, 1000);

render();
</script>
</body>
</html>
