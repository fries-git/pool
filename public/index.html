<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multiplayer Pool</title>
<style>
  html,body{margin:0;padding:0;height:100%;font-family:system-ui;background:#121212;color:#eee;display:flex;flex-direction:column;align-items:center;}
  #topbar{margin:12px;display:flex;gap:8px;align-items:center;}
  input,button{padding:6px 12px;border-radius:6px;border:none;font-size:14px;}
  input{width:100px;text-transform:uppercase;background:#1e1e1e;color:#eee;}
  button{background:#2a9df4;color:#fff;cursor:pointer;transition:0.2s;box-shadow:0 2px 6px rgba(0,0,0,0.5);}
  button:hover{background:#1c7ecf;}
  #status{margin-left:10px;font-weight:bold;color:#aaa;}
  #canvas{border:6px solid #1e1e1e;box-shadow:0 8px 20px rgba(0,0,0,0.7);background:#01361f;margin-top:12px;}
</style>
</head>
<body>

<div id="topbar">
  <input id="username" placeholder="USERNAME"/>
  <button id="create">Create Room</button>
  <input id="room" placeholder="ROOM"/>
  <button id="join">Join Room</button>
  <span id="status">disconnected</span>
</div>

<canvas id="canvas" width="800" height="400"></canvas>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let ws,roomCode=null,state=null,myId=null,username=null;
const statusEl=document.getElementById('status');

function status(s){statusEl.textContent=s;}

function connect(){
  if(ws && (ws.readyState===1||ws.readyState===0)) return;
  ws=new WebSocket("wss://pool-o8c6.onrender.com");
  ws.onopen=()=>status('connected');
  ws.onclose=()=>status('disconnected');
  ws.onmessage=(ev)=>{
    const m=JSON.parse(ev.data);
    if(m.t==='joined'){roomCode=m.code;myId=m.id||null;status('in room '+roomCode);}
    else if(m.t==='state'){state=m.state;}
    else if(m.t==='error'){status('error: '+m.msg);}
  };
}

// Create room
document.getElementById('create').onclick=()=>{
  username=document.getElementById('username').value.trim()||'Player';
  connect();
  if(ws.readyState===1){ws.send(JSON.stringify({t:'create',name:username}));status('creating...');}
  else ws.addEventListener('open',()=>{ws.send(JSON.stringify({t:'create',name:username}));status('creating...');},{once:true});
};

// Join room
document.getElementById('join').onclick=()=>{
  username=document.getElementById('username').value.trim()||'Player';
  const code=document.getElementById('room').value.trim().toUpperCase();
  if(!code) return;
  connect();
  if(ws.readyState===1){ws.send(JSON.stringify({t:'join',code,name:username}));status('joining...');}
  else ws.addEventListener('open',()=>{ws.send(JSON.stringify({t:'join',code,name:username}));status('joining...');},{once:true});
};

// Draw loop
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#01361f';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  if(state){
    for(const b of state.balls) drawBall(b);
    if(drag) renderAimLine(drag.cue.x,drag.cue.y,drag.mx,drag.my);
  }else{
    ctx.fillStyle='#aaa';ctx.font='16px system-ui';ctx.fillText('Create or join a room to start.',20,30);
  }
  requestAnimationFrame(draw);
}

function drawBall(b){ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fillStyle=b.id==='cue'?'#fff':'#e24d4d';ctx.fill();ctx.strokeStyle='#222';ctx.lineWidth=1.5;ctx.stroke();}

// Input: click-drag to shoot with short aim preview
let drag=null;
canvas.addEventListener('mousedown',e=>{
  if(!state) return;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left,y=e.clientY-rect.top;
  const cue=state.balls.find(b=>b.id==='cue');
  if(!cue) return;
  drag={x0:x,y0:y,cue,cx:cue.x,cy:cue.y,mx:x,my:y};
});
canvas.addEventListener('mousemove',e=>{
  if(!drag) return;
  const rect=canvas.getBoundingClientRect();
  drag.mx=e.clientX-rect.left;
  drag.my=e.clientY-rect.top;
});
window.addEventListener('mouseup',e=>{
  if(!drag) return;
  const dx=drag.cx-drag.mx,dy=drag.cy-drag.my;
  const dist=Math.hypot(dx,dy),power=Math.min(1,dist/150);
  const angle=Math.atan2(dy,dx)+Math.PI;
  if(ws && ws.readyState===1) ws.send(JSON.stringify({t:'shoot',power,angle}));
  drag=null;
});

function renderAimLine(cx,cy,mx,my){
  const dx=mx-cx,dy=my-cy;
  const length=50; // short line preview
  const angle=Math.atan2(dy,dx);
  const ex=cx+Math.cos(angle)*length;
  const ey=cy+Math.sin(angle)*length;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(ex,ey);
  ctx.strokeStyle='#fff';
  ctx.lineWidth=2;
  ctx.stroke();
}

// auto-request state
setInterval(()=>{if(ws && ws.readyState===1) ws.send(JSON.stringify({t:'request_state'}));},2000);

draw();
</script>
</body>
</html>
